<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <meta name="description" content="Backgammon Score board App">
  <meta name="description" content="Inspired by hkitago's Backgammon Scoreboard App">
  <meta name="author" content="(C)hinacoppy 2019">
  <link rel="stylesheet" href="css/bgscore.css">
  <link rel="icon" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <title>bgscore</title>
</head>

<body>
<article id="mainwindow" class="mainwin">
<div id="score1">
<div class="cardcontainer">
<div id="score1curr" class="card curr">0</div>
<div id="score1next" class="card next"></div>
</div></div>

<div id="score2">
<div class="cardcontainer">
<div id="score2curr" class="card curr">0</div>
<div id="score2next" class="card next"></div>
</div></div>

<div id="matchinfo">5</div>
<div id="crawfordinfo"></div>
<div id="settingbtn" class="oparationbtn">SETTINGS</div>
</article>

<!-- 設定画面 -->
<aside id="settingwindow" class="setting">
<h2>### Backgammon Score board App Settings ###</h2>
<p>
Match length:
<select id="matchlength" name="matchlength">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="5" selected>5</option>
<option value="7">7</option>
<option value="9">9</option>
<option value="11">11</option>
<option value="13">13</option>
<option value="15">15</option>
<option value="17">17</option>
<option value="19">19</option>
<option value="21">21</option>
<option value="23">23</option>
<option value="25">25</option>
</select>
(0 = Unlimited)
</p>

<br><br>
<div>
<span id="applybtn" class="oparationbtn">RESET SCORE</span> &emsp;&emsp;&emsp;&emsp;
<span id="cancelbtn" class="oparationbtn">&emsp;CANCEL&emsp;</span>
</div>
<br>
<h2>使い方</h2>
<p>[RESET SCORE] をタップすると、スコアは 0 にリセットされます。</p>
<p>カードがめくれなくなった時には一度設定画面に切り替えてください。<br>その際は [CANCEL] ボタンで戻ってください。</p>
<p>カードを左方向にスワイプすれば、数字を戻すことができます。</p>
</aside>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.mobile-events.min.js"></script>
<script>
"use strict";

var score = [0, 0, 0];
var matchlen = 5;
var maxscore = matchlen;
var crawford = 0;
var cfplayer = 0;
const mainwin = $("#mainwindow");
const setting = $("#settingwindow");

$(function () {

  //設定画面の[RESET SCORE]ボタンがクリックされたとき
  $("#applybtn").on("click", () => {
    reset_score();
    $("#cancelbtn").trigger("click");
  });

  //設定画面の[CANCEL]ボタンがクリックされたとき
  $("#cancelbtn").on("click", () => {
    mainwin.show();
    $(".card").removeClass("flipup90 flipdn90 flipup0 flipdn0"); //タップ連打でバグった時に解除する
    setting.removeClass("fliphoriz0").on("transitionend",  () => {
      mainwin.removeClass("fliphoriz90");
      setting.off("transitionend").hide();
    });
  });

  //メイン画面の[SETTINGS]ボタンがクリックされたとき
  $("#settingbtn").on("click", () => {
    setting.show();
    mainwin.addClass("fliphoriz90").on("transitionend",  () => {
      setting.addClass("fliphoriz0");
      mainwin.off("transitionend").hide();
    });
  });

  //スコアカードがスワイプあるいはタップされたとき→1枚めくる
  $("#score1, #score2").on("swiperight swipeleft tap", (e) => {
    const player = parseInt($(e.currentTarget).attr("id").slice(-1));
    if (e.type == "swiperight" || e.type == "tap") {
      const opt = {delta: +1, transform_n: "next", transition_c: "flipup90", transition_n: "flipup0"};
      cardFlip(player, opt);
    } else if (e.type == "swipeleft") {
      const opt = {delta: -1, transform_n: "prev", transition_c: "flipdn90", transition_n: "flipdn0"};
      cardFlip(player, opt);
    }
  });

});

//カードをめくる
function cardFlip(player, opt) {
  const cardcurr = $("#score" + player + "curr");
  const cardnext = $("#score" + player + "next");

  const scrcurr = score[player];
  const scrnext = nextscore(scrcurr, opt.delta);
  score[player] = scrnext;

  if (scrcurr == scrnext) { return; }

  cardnext.text(scrnext).addClass(opt.transform_n).show();
  cardcurr.addClass(opt.transition_c).on("transitionend",  () => {
    cardcurr.off("transitionend");
    cardnext.addClass(opt.transition_n).on("transitionend",  () => {
      cardcurr.text(scrnext).removeClass(opt.transition_c);
      cardnext.hide().removeClass(opt.transform_n).removeClass(opt.transition_n).off("transitionend");
      check_crawford(player);
    });
  });
}

//次カードのスコアを計算
function nextscore(sc, delta) {
  let nx = sc + delta;
  if (nx > maxscore) { nx = maxscore; }
  if (nx < 0) { nx = 0; }
  return nx;
}

//Crawfordかどうかを判断
function check_crawford(player) {
  let cfstr;
  if (matchlen - score[player] == 1 && crawford == 0) {
    crawford = 1; cfplayer = player; cfstr = "Crawford";
  } else if (crawford == 2 || (crawford == 1 && cfplayer != player)) {
    crawford = 2; cfplayer = 0;      cfstr = "Post<br>Crawford";
  } else {
    crawford = 0; cfplayer = 0;      cfstr = "";
  }
  $("#crawfordinfo").html(cfstr);
}

//設定画面でapplyした際に初期設定に戻す
function reset_score() {
  score = [0, 0, 0];
  crawford = 0;
  cfplayer = 0;
  matchlen = parseInt( $("#matchlength").val() );
  maxscore = (matchlen == 0) ? 99 : matchlen;
  const matchinfo = (matchlen == 0) ? "$" : matchlen;
  $("#matchinfo").text(matchinfo);
  $("#crawfordinfo").text("");
  $("#score1curr,#score1next").text(score[1]);
  $("#score2curr,#score2next").text(score[2]);
}
</script>
</body>
</html>
